# SYSTEM.PRO - Chat Module Specification
# Modul pro skupinové konverzace

module:
  id: chat
  name: Chat
  description: Skupinové konverzace pro komunikaci mezi zaměstnanci
  component: ChatModule
  store: useChatStore
  icon: MessagesSquare

access:
  roles:
    - role-1  # Prodavač
    - role-2  # Administrátor
    - role-3  # Skladník
    - role-4  # Vedoucí skladu
    - role-5  # Obsluha e-shopu
    - role-6  # Obchodník
    - role-7  # Vedoucí velkoobchodu
    - role-8  # Majitel

  admin_features:
    # Pouze Administrátor může spravovat skupiny
    group_management: [role-2]

data_model:
  chatGroup:
    id: string
    name: string
    type: group | direct  # typ skupiny
    memberIds: string[]  # userIds
    createdAt: ISO8601
    createdBy: string  # userId

  chatMessage:
    id: string
    groupId: string
    userId: string  # autor
    text: string
    attachments: ChatAttachment[]
    reactions: ChatReaction[]
    createdAt: ISO8601

  chatReaction:
    type: thumbsUp | heart | laugh | wow | sad | angry
    userId: string
    createdAt: ISO8601

  chatReadStatus:
    groupId: string
    userId: string
    lastReadMessageId: string
    lastReadAt: ISO8601

  chatAttachment:
    id: string
    type: image | file
    url: string
    name: string
    size: number

features:
  - id: view_groups
    name: Zobrazení skupin
    description: Uživatel vidí pouze skupiny, kde je členem
    acceptance_criteria:
      - Skupiny seřazeny podle času poslední zprávy
      - Zobrazuje se počet nepřečtených zpráv
      - Skupiny bez zpráv jsou na konci

  - id: send_message
    name: Odeslání zprávy
    description: Odeslání textové zprávy do skupiny
    acceptance_criteria:
      - Zpráva se okamžitě zobrazí v konverzaci
      - Automaticky se označí jako přečtená pro odesílatele
      - Ostatní členové vidí jako nepřečtenou

  - id: reactions
    name: Reakce na zprávy
    description: Přidání/odebrání reakce na zprávu
    acceptance_criteria:
      - 6 typů reakcí: thumbsUp, heart, laugh, wow, sad, angry
      - Jedna reakce typu na uživatele na zprávu
      - Klik na existující reakci ji odebere

  - id: read_status
    name: Stav přečtení
    description: Sledování přečtených zpráv
    acceptance_criteria:
      - Otevření skupiny označí všechny zprávy jako přečtené
      - Nepřečtené se počítají od lastReadAt
      - Vlastní zprávy se nepočítají do nepřečtených

  - id: search
    name: Vyhledávání
    description: Vyhledávání v zprávách aktuální skupiny
    acceptance_criteria:
      - Filtruje zprávy obsahující hledaný text
      - Case-insensitive vyhledávání
      - Vyhledává pouze v aktuálně otevřené skupině

  - id: group_management
    name: Správa skupin (admin)
    description: Vytváření, editace a mazání skupin
    acceptance_criteria:
      - Pouze Administrátor (role-2) má přístup
      - Vytvoření nové skupiny s názvem a členy
      - Editace existující skupiny (název, členové)
      - Smazání skupiny (včetně všech zpráv)
      - Konfigurace v nastavení modulu (Module Settings)

  - id: clickable_urls
    name: Klikatelné URL odkazy
    description: URL adresy ve zprávách se automaticky detekují a zobrazují jako klikatelné hypertextové odkazy
    acceptance_criteria:
      - URL (http/https) ve zprávě se vykreslí jako <a> tag
      - Klik otevře odkaz v novém tabu (target="_blank")
      - Vlastní zprávy: odkaz bílý s podtržením (dědí barvu textu)
      - Cizí zprávy: odkaz modrý s podtržením (text-blue-600)

  - id: delete_message
    name: Mazání vlastních zpráv
    description: Uživatel může smazat vlastní zprávy
    acceptance_criteria:
      - Tlačítko Trash2 viditelné na hover pouze u vlastních zpráv
      - Potvrzovací dialog před smazáním
      - Po smazání zpráva zmizí u všech uživatelů (realtime DELETE)

  - id: direct_messages
    name: Přímé zprávy (1:1)
    description: Uživatel může poslat přímou zprávu jinému zaměstnanci
    acceptance_criteria:
      - Tlačítko "Nová zpráva" v seznamu skupin
      - Modal s výběrem aktivního zaměstnance
      - Existující DM se znovuotevře místo vytvoření nové
      - DM řazeny abecedně dle jména druhé osoby pod admin skupinami
      - Ikona User u DM, ikona Users u skupin
      - Header zobrazuje jméno druhé osoby a "Přímá zpráva"
      - Admin nevidí DM v nastavení skupin

  - id: emoji_picker
    name: Emoji picker
    description: Vložení emoji do zprávy přes picker
    acceptance_criteria:
      - Tlačítko Smile vedle přílohy v inputu
      - Klik otevře emoji-mart picker nad inputem
      - Výběr emoji vloží na pozici kurzoru v textarea
      - Click-outside zavře picker

  - id: realtime
    name: Supabase Realtime
    description: Real-time propagace zpráv, skupin a stavů přečtení přes Supabase Realtime
    acceptance_criteria:
      - Nové zprávy se zobrazí ostatním uživatelům okamžitě bez refreshe
      - Smazané zprávy zmizí u ostatních uživatelů okamžitě (DELETE event)
      - Nové DM skupiny se zobrazí druhému uživateli okamžitě (INSERT event)
      - Stav přečtení se synchronizuje přes WebSocket
      - Automatická reconnect při ztrátě spojení

notifications:
  badge:
    type: count
    source: getUnreadCountForUser(userId)
    description: >
      Celkový počet nepřečtených zpráv ze všech skupin.
      Zprávy od sebe sama se nepočítají.

  calculation:
    - Pro každou skupinu kde je uživatel členem
    - Počet zpráv po lastReadAt (nebo všechny pokud nemá readStatus)
    - Vynechání zpráv kde userId === currentUserId

scenarios:
  - id: CHAT-001
    name: Základní konverzace
    preconditions:
      - Existuje skupina "Všichni" s více členy
      - Uživatel je členem skupiny
    steps:
      - Otevřu modul Chat
      - Vidím seznam skupin
      - Kliknu na skupinu "Všichni"
      - Vidím historii zpráv
      - Napíšu zprávu "Ahoj všem"
      - Kliknu Odeslat
      - Zpráva se zobrazí v konverzaci
      - Přepnu se na jiného uživatele
      - Vidím badge na modulu Chat
      - Otevřu skupinu, vidím nepřečtenou zprávu
    expected:
      - Zpráva se doručí všem členům
      - Badge se správně aktualizuje

  - id: CHAT-002
    name: Reakce na zprávu
    preconditions:
      - Existuje zpráva od jiného uživatele
    steps:
      - Otevřu skupinu s existující zprávou
      - Najedu na zprávu, objeví se menu reakcí
      - Kliknu na "thumbsUp"
      - Reakce se zobrazí pod zprávou
      - Kliknu znovu na "thumbsUp"
      - Reakce se odebere
    expected:
      - Reakce se přidává/odebírá toggle akcí
      - Zobrazuje se počet reakcí každého typu

  - id: CHAT-003
    name: Správa skupin (admin)
    preconditions:
      - Uživatel je přihlášen jako Administrátor
    steps:
      - Otevřu nastavení modulu Chat (Module Settings)
      - Kliknu na "Nová skupina"
      - Zadám název "Test skupina"
      - Vyberu členy
      - Kliknu Uložit
      - Skupina se vytvoří
      - Kliknu na editaci existující skupiny
      - Změním název a členy
      - Uložím změny
      - Kliknu na smazání skupiny
      - Potvrdím smazání
    expected:
      - Administrátor může plně spravovat skupiny
      - Změny se projeví okamžitě pro všechny členy

  - id: CHAT-004
    name: Vyhledávání v konverzaci
    preconditions:
      - Skupina obsahuje několik zpráv s různým textem
    steps:
      - Otevřu skupinu
      - Do vyhledávacího pole zadám text
      - Zobrazí se pouze zprávy obsahující text
      - Vymažu vyhledávání
      - Zobrazí se všechny zprávy
    expected:
      - Filtrování funguje okamžitě
      - Case-insensitive

  - id: CHAT-005
    name: Přístup do skupin podle členství
    preconditions:
      - Existuje skupina "Vedení" s omezeným počtem členů
      - Uživatel není členem této skupiny
    steps:
      - Přihlásím se jako uživatel mimo skupinu
      - Otevřu modul Chat
      - Skupina "Vedení" se nezobrazuje v seznamu
      - Přihlásím se jako člen skupiny
      - Skupina "Vedení" se zobrazuje
    expected:
      - Uživatel vidí pouze skupiny kde je členem

  - id: CHAT-006
    name: Realtime multi-klient
    preconditions:
      - Dva uživatelé mají otevřen stejný chat ve dvou prohlížečích
    steps:
      - Uživatel A pošle zprávu do skupiny
      - Uživatel B sleduje konverzaci
    expected:
      - Zpráva se okamžitě objeví u uživatele B bez refreshe
      - Badge se aktualizuje pro uživatele B

  - id: CHAT-007
    name: Klikatelné URL v chatové zprávě
    preconditions:
      - Existuje skupina s členy
      - Uživatel je členem skupiny
    steps:
      - Otevřu skupinu
      - Napíšu zprávu obsahující URL (např. "Podívej se na https://example.com prosím")
      - Odešlu zprávu
      - Zpráva se zobrazí s URL jako klikatelným odkazem
      - Kliknu na odkaz
    expected:
      - URL je zobrazena jako podtržený odkaz
      - Klik otevře URL v novém tabu prohlížeče
      - Vlastní zpráva: odkaz bílý (dědí barvu), cizí zpráva: odkaz modrý

  - id: CHAT-008
    name: Mazání vlastní zprávy
    preconditions:
      - Uživatel má odeslané zprávy v konverzaci
    steps:
      - Otevřu skupinu s vlastními zprávami
      - Najedu na vlastní zprávu, objeví se ikona koše
      - Kliknu na ikonu koše
      - Potvrdím smazání v dialogu
    expected:
      - Zpráva zmizí z konverzace
      - Zpráva zmizí i u ostatních uživatelů (realtime)
      - Ikona koše se nezobrazuje u cizích zpráv

  - id: CHAT-009
    name: Přímá zpráva (1:1)
    preconditions:
      - Existují aktivní zaměstnanci v systému
    steps:
      - Otevřu modul Chat
      - Kliknu na "Nová zpráva"
      - Zobrazí se modal se seznamem zaměstnanců
      - Vyberu zaměstnance
      - Otevře se nová konverzace
      - Napíšu a odešlu zprávu
      - Druhý uživatel vidí novou konverzaci v seznamu
    expected:
      - DM se vytvoří s type "direct"
      - V seznamu se zobrazuje jméno druhé osoby
      - Header zobrazuje "Přímá zpráva"
      - Opakovaný klik na stejného zaměstnance otevře existující DM

  - id: CHAT-010
    name: Emoji picker
    preconditions:
      - Otevřena konverzace
    steps:
      - Kliknu na ikonu smajlíka v input baru
      - Zobrazí se emoji picker
      - Vyberu emoji
      - Emoji se vloží do textu zprávy
      - Kliknu mimo picker
      - Picker se zavře
    expected:
      - Emoji se vloží na pozici kurzoru
      - Po výběru emoji je fokus zpět na textarea
      - Click-outside zavře picker

edge_cases:
  - id: CHAT-E001
    name: Prázdná skupina
    description: Skupina bez zpráv
    expected: >
      Zobrazí se prázdný stav s textem "Zatím žádné zprávy".
      Badge je 0.

  - id: CHAT-E002
    name: Odebrání ze skupiny
    description: Admin odebere uživatele ze skupiny
    expected: >
      Uživatel již nevidí skupinu v seznamu.
      Zprávy zůstávají pro ostatní členy.
      Badge se přepočítá bez této skupiny.

  - id: CHAT-E003
    name: Smazání skupiny s nepřečtenými
    description: Admin smaže skupinu která má nepřečtené zprávy
    expected: >
      Skupina zmizí ze seznamu.
      Badge se přepočítá.
      Zprávy a readStatuses se smažou.

  - id: CHAT-E004
    name: Více oken/sessions
    description: Uživatel má otevřeno více oken aplikace
    expected: >
      Supabase Realtime synchronizuje nové zprávy a stav přečtení
      přes WebSocket na všechny připojené klienty v reálném čase.

  - id: CHAT-E005
    name: DM se sebou samým
    description: Uživatel by neměl moci vytvořit DM se sebou
    expected: >
      V modalu pro novou zprávu se aktuální uživatel nezobrazuje.

  - id: CHAT-E006
    name: Duplicitní DM
    description: Uživatel se pokusí vytvořit DM s osobou, se kterou už DM existuje
    expected: >
      Systém nalezne existující DM a otevře ji místo vytvoření nové.

  - id: CHAT-E007
    name: Admin nastavení nevidí DM
    description: Administrátor otevře nastavení chat skupin
    expected: >
      V tabulce se zobrazují pouze skupiny typu "group".
      DM konverzace se nezobrazují v admin nastavení.
