# SYSTEM.PRO - Prevodky (Transfer Orders) Module Specification
# Interni prevodky s picking systemem a EAN skenovani

module:
  id: prevodky
  name: Prevodky
  description: Interni prevodni doklady se systemem vychystavani (picking) a EAN skenovani
  component: AutomatizaceSettings (sekce Prevodky)
  store: usePrevodkyStore
  icon: Truck

access:
  roles:
    - role-2  # Administrator (generovani, prehled, detail, zruseni)
    - role-8  # Majitel (generovani, prehled, detail, zruseni)
  employee_access:
    - Vsichni zamestnanci prideleni jako pickeri (picking UI)

  notes:
    - Admin generuje prevodky z vypoctu rozdeleni zbozi
    - Admin priradi pickera (zamestnance) ke kazde prodejne
    - Picker otevre ukol a skenuje EAN kody
    - Delegace ukolu mozna pres existujici task system

data_model:
  prevodka:
    id: string (UUID)
    cisloPrevodky: string  # format PV-YYYY-NNN
    zdrojovySklad: string  # default ALL_Zdiby
    cilovySklad: string  # nazev prodejny
    stav: PrevodkaStav  # nova|picking|vychystano|odeslano|potvrzeno|zrusena
    prirazenoKomu: string | null  # ID pickera
    vytvoreno: string  # timestamptz
    zahajeno: string | null  # kdy picker zacal
    vychystano: string | null  # kdy dokoncil picking
    odeslano: string | null  # kdy fyzicky odeslano
    potvrzeno: string | null  # kdy prijato na prodejne
    zruseno: string | null  # kdy zruseno
    poznamka: string | null  # poznamka pickera (povinna pri partial)
    vytvoril: string  # ID admina
    pohodaOdeslano: boolean  # true po uspesnem odeslani do Pohody
    pohodaCisloDokladu: string | null  # cislo dokladu z Pohody (napr. 26SPr00253)
    pohodaChyba: string | null  # chybova zprava z Pohody
    pohodaOdeslanoAt: string | null  # cas odeslani do Pohody
    ukolId: string | null  # vazba na ukoly
    polozky: PrevodkaPolozka[]

  prevodkaPolozka:
    id: string (UUID)
    prevodkaId: string
    kod: string  # EAN/kod produktu
    nazev: string
    pozice: string | null  # pozice ve skladu (H10/04)
    pozadovaneMnozstvi: number
    skutecneMnozstvi: number | null  # kolik skutecne vzal
    vychystano: boolean
    casVychystani: string | null
    poradi: number  # razeni dle pozice

  prevodkaStav:
    values:
      - nova  # vytvorena, ceka na pickera
      - picking  # zamestnanec aktivne vychystava
      - vychystano  # vse nasnenovano
      - odeslano  # zbozi fyzicky odeslano
      - potvrzeno  # prijato na prodejne (budouci faze)
      - zrusena  # zrusena prevodka

  storeState:
    prevodky: Prevodka[]
    _loaded: boolean
    _loading: boolean
    isGenerating: boolean
    generateProgress: string | null
    generateError: string | null
    isSendingToPohoda: boolean
    pickingPrevodkaId: string | null
    selectedPrevodkaId: string | null
    stavFilter: PrevodkaStav | aktivni | all

db_tables:
  prevodky:
    description: Hlavni tabulka prevodnich dokladu
    columns:
      - id: uuid PK DEFAULT gen_random_uuid()
      - cislo_prevodky: text NOT NULL
      - zdrojovy_sklad: text NOT NULL DEFAULT 'ALL_Zdiby'
      - cilovy_sklad: text NOT NULL
      - stav: text NOT NULL DEFAULT 'nova'
      - prirazeno_komu: text REFERENCES zamestnanci(id)
      - vytvoreno: timestamptz NOT NULL DEFAULT now()
      - zahajeno: timestamptz
      - vychystano: timestamptz
      - odeslano: timestamptz
      - potvrzeno: timestamptz
      - zruseno: timestamptz
      - poznamka: text
      - vytvoril: text REFERENCES zamestnanci(id)
      - pohoda_odeslano: boolean DEFAULT false
      - pohoda_cislo_dokladu: text
      - pohoda_chyba: text
      - pohoda_odeslano_at: timestamptz
      - ukol_id: text REFERENCES ukoly(id) ON DELETE SET NULL
    indexes:
      - idx_prevodky_stav ON prevodky(stav)
      - idx_prevodky_prirazeno ON prevodky(prirazeno_komu)
    rls: enabled
    policies:
      - SELECT pro authenticated
      - INSERT pro authenticated
      - UPDATE pro authenticated

  prevodky_polozky:
    description: Polozky prevodnich dokladu
    columns:
      - id: uuid PK DEFAULT gen_random_uuid()
      - prevodka_id: uuid NOT NULL REFERENCES prevodky(id) ON DELETE CASCADE
      - kod: text NOT NULL
      - nazev: text NOT NULL
      - pozice: text
      - pozadovane_mnozstvi: integer NOT NULL
      - skutecne_mnozstvi: integer
      - vychystano: boolean DEFAULT false
      - cas_vychystani: timestamptz
      - poradi: integer NOT NULL DEFAULT 0
    indexes:
      - idx_prevodky_polozky_prevodka ON prevodky_polozky(prevodka_id)
    rls: enabled
    policies:
      - SELECT pro authenticated
      - INSERT pro authenticated
      - UPDATE pro authenticated

  ukoly_update:
    description: Pridani sloupce typ_ukolu do tabulky ukoly
    columns:
      - typ_ukolu: text DEFAULT 'obecny'  # obecny|prevodka

features:
  - id: generate-prevodky
    name: Generovani prevodek
    description: Admin vybere pickery pro kazdu prodejnu a vygeneruje prevodky + ukoly
    acceptance_criteria:
      - Admin klikne "Generovat prevodky" v Automatizace nastaveni
      - Dialog zobrazi vsechny delivery prodejny s dropdown pro vyber pickera
      - Po potvrzeni se pro kazdou prodejnu s polozkamivytvori prevodka + ukol
      - Ukol je typu 'prevodka' s vysokou prioritou
      - Cislovani PV-YYYY-NNN s automatickym inkrementem

  - id: picking-ui
    name: Picking UI s EAN skenovani
    description: Fullscreen view pro skladniky s EAN scanner podporou
    acceptance_criteria:
      - Picker otevre ukol typu prevodka -> automaticky se otevre picking UI
      - Seznam polozek serazeny dle pozice ve skladu
      - Velke vstupni pole pro EAN (hardware scanner posila Enter)
      - Qty=1 se automaticky potvrdi
      - Qty>1 zobrazi dialog s cislem (predvyplneno)
      - Neznamy EAN -> cervena hlaska "Produkt neni v prevodce"
      - Progress bar ukazuje postup vychystavani
      - Dokonceni s poznamkou pokud neni vse vychystano

  - id: admin-overview
    name: Prehled prevodek
    description: Tabulka s prehledem vsech prevodek pro admina
    acceptance_criteria:
      - Tabulka zobrazuje cislo, cil, picker, stav, polozky (X/Y), vytvoreno
      - Filtrovani dle stavu (aktivni, nove, picking, vychystane, odeslane, zrusene)
      - Klik na radek otevre detail view
      - Tlacitko "Zrusit" u nedokoncenych

  - id: prevodka-detail
    name: Detail prevodky
    description: Detailni zobrazeni prevodky s polozkami
    acceptance_criteria:
      - Hlavicka s cislem, cilem, pickerem, stavem, casy
      - Seznam polozek s barevnym oznacenim (zelena OK, oranzova partial, cervena chybi)
      - Poznamka pickera pokud partial
      - Akce "Odeslat do Pohody" u vychystanych (pred odeslanim)
      - Akce "Oznacit jako odeslano" u vychystanych (po odeslani do Pohody)
      - Akce "Zrusit prevodku" u nedokoncenych
      - Pohoda status sekce (zelena uspech s cislem dokladu, cervena chyba s tlacitkem retry)

  - id: pohoda-integration
    name: Odeslani prevodky do Pohody
    description: Manualni odeslani prevodky do ucetniho systemu Pohoda pres mServer XML API
    acceptance_criteria:
      - Admin klikne "Odeslat do Pohody" v detailu vychystane prevodky
      - Edge Function send-prevodka sestavi XML s ciselnou radou SPr
      - XML obsahuje skutecne vychystane mnozstvi (ne pozadovane)
      - Po uspesnem odeslani se zobrazi cislo dokladu z Pohody
      - Stav se automaticky zmeni na odeslano
      - Pri chybe se zobrazi chybova zprava a tlacitko "Odeslat znovu"
      - Prevodka jiz odeslana do Pohody nelze odeslat znovu

  - id: add-product-picking
    name: Rucni pridani produktu pri pickingu
    description: Picker muze rucne pridat produkt do prevodky pomoci vyhledavani podle nazvu/kodu/EAN
    acceptance_criteria:
      - Tlacitko "Pridat produkt" v headeru picking UI
      - Fullscreen dialog s vyhledavanim v pohoda_zasoby (zdrojovy sklad)
      - Hledani podle kodu, nazvu a EAN (case-insensitive, debounce 300ms)
      - Vysledky zobrazuji pozici, nazev, kod a EAN
      - Klik na produkt zobrazi pocet kusu s +/- tlacitky
      - Po pridani se produkt ulozi jako rovnou vychystany
      - Upozorneni pokud produkt jiz v prevodce existuje (moznost presto pridat)
      - Dialog zustava otevreny pro pridani dalsich produktu

  - id: task-integration
    name: Integrace s ukoly
    description: Propojeni prevodek s existujicim task systemem
    acceptance_criteria:
      - Prevodka ma vazbu 1:1 na ukol (ukol_id)
      - Ukol typu 'prevodka' otevira picking UI misto task detailu
      - Tlacitko "Otevrit picking" v task detail modalu
      - Delegace pres existujici mechanismus

notifications:
  badge:
    type: none
    description: Prevodky nemaji vlastni badge, notifikace jdou pres ukoly

scenarios:
  - id: PREV-001
    name: Generovani prevodek
    preconditions: Admin je prihlasen, existuji podklady cilovych stavu
    steps:
      - Admin otevre Automatizace > Prevodky
      - Klikne "Generovat prevodky"
      - V dialogu vybere pickery pro prodejny
      - Klikne "Generovat"
    expected:
      - System vytvori N prevodek (1 per prodejna s polozkam)
      - Kazda prevodka ma prirazeny ukol typu 'prevodka'
      - V prehledu vidim nove prevodky se stavem "nova"

  - id: PREV-002
    name: Picking s EAN skenovani
    preconditions: Existuje prevodka prirazena pickerovi
    steps:
      - Picker otevre ukol typu prevodka
      - Picking UI se otevre automaticky, stav -> picking
      - Picker naskenuje EAN kod (qty=1) -> polozka potvrzena
      - Picker naskenuje EAN kod (qty>1) -> zobrazi dialog
      - Picker potvrdi mnozstvi -> polozka potvrzena
      - Vsechny polozky hotove -> klikne "Dokoncit picking"
    expected:
      - Kazda naskenove polozka je oznacena jako vychystana
      - Progress bar ukazuje postup
      - Po dokonceni stav -> vychystano

  - id: PREV-003
    name: Partial picking s poznamkou
    preconditions: Picker vychystava prevodku, nektere polozky chybi
    steps:
      - Picker neskenuje vsechny polozky
      - Klikne "Dokoncit picking"
      - Zobrazi se dialog s povinnou poznamkou
      - Zada duvod a potvrdi
    expected:
      - Prevodka ma stav "vychystano" s poznamkou
      - Admin vidi poznamku v detail view

  - id: PREV-004
    name: Odeslani prevodky
    preconditions: Prevodka ve stavu vychystano
    steps:
      - Admin otevre detail prevodky
      - Klikne "Oznacit jako odeslano"
    expected:
      - Stav -> odeslano s casovym razitkem

  - id: PREV-005
    name: Zruseni prevodky
    preconditions: Prevodka ve stavu nova nebo picking
    steps:
      - Admin otevre detail prevodky
      - Klikne "Zrusit prevodku"
      - Potvrdi v dialogu
    expected:
      - Stav -> zrusena
      - Prirazeny ukol je smazan

  - id: PREV-006
    name: Rucni pridani produktu pri pickingu
    preconditions: Picker ma otevreny picking UI
    steps:
      - Picker klikne "Pridat produkt" v headeru
      - Otevre se fullscreen dialog s vyhledavanim
      - Zada nazev nebo kod produktu (min 2 znaky)
      - V tabulce vybere produkt
      - Zada pocet kusu a klikne "Pridat"
    expected:
      - Produkt se prida do seznamu jako vychystany (zeleny)
      - Zelena hlaska "Produkt pridan"
      - Dialog zustava otevreny pro dalsi pridani
      - Po zavreni dialogu se novy produkt zobrazi v seznamu

  - id: PREV-008
    name: Odeslani prevodky do Pohody
    preconditions: Admin je prihlasen, prevodka ve stavu vychystano
    steps:
      - Admin otevre detail prevodky ve stavu vychystano
      - Klikne "Odeslat do Pohody"
      - System odesle XML na mServer s ciselnou radou SPr
      - Pohoda zpracuje prevodku a vrati cislo dokladu
    expected:
      - Zeleny badge s cislem dokladu z Pohody (napr. 26SPr00253)
      - Stav prevodky se zmeni na odeslano
      - Tlacitko "Odeslat do Pohody" zmizi
      - Pri chybe: cerveny badge s chybou + tlacitko "Odeslat znovu"

  - id: PREV-007
    name: Pridani duplicitniho produktu
    preconditions: Picker ma otevreny picking UI, produkt jiz v prevodce
    steps:
      - Picker klikne "Pridat produkt"
      - Vyhleda a vybere produkt ktery jiz je v prevodce
    expected:
      - U produktu se zobrazi badge "v prevodce"
      - Oranzove upozorneni "Produkt jiz je v prevodce"
      - Picker muze presto pridat (nova polozka s vlastnim mnozstvim)

edge_cases:
  - id: PREV-E001
    description: Neznamy EAN kod naskenovan
    expected: Cervena hlaska "Produkt neni v prevodce", zadna polozka se nezmeni

  - id: PREV-E002
    description: Jiz vychystany produkt naskenovan znovu
    expected: Hlaska "Jiz vychystano", zadna zmena

  - id: PREV-E003
    description: Prodejna bez polozek k dodani
    expected: Prevodka se nevytvori, jen prodejny s alespon 1 polozkou

  - id: PREV-E004
    description: Pokus o zruseni odeslane prevodky
    expected: API vrati chybu 400, prevodka zustava nezmenena

  - id: PREV-E005
    description: Generovani bez prirazeni pickeru
    expected: API vrati chybu 400, zadna prevodka se nevytvori

  - id: PREV-E006
    description: Vyhledavani produktu s mene nez 2 znaky
    expected: Zadne vysledky, hint "Zadejte alespon 2 znaky"

  - id: PREV-E007
    description: Vyhledavani produktu bez vysledku
    expected: Hlaska "Zadne vysledky"

  - id: PREV-E008
    description: Odeslani do Pohody selhalo (sitova chyba nebo mServer nedostupny)
    expected: Stav zustane vychystano, pohoda_chyba obsahuje popis chyby, tlacitko Odeslat znovu

  - id: PREV-E009
    description: Pokus o odeslani jiz odeslane prevodky
    expected: Edge function vrati chybu "Prevodka uz byla odeslana do Pohody"

  - id: PREV-E010
    description: Prevodka bez vychystanych polozek
    expected: Edge function vrati chybu "Zadne polozky k odeslani"
